System.registerDynamic("dist/directives/canvas.view.directive.js",["@angular/core"],!0,function(a,b,c){"use strict";var d=(this||self,this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g}),e=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)};const f=a("@angular/core");let g=class a{};return g=d([f.Directive({selector:"view-canvas"}),e("design:paramtypes",[])],g),c.exports}),System.registerDynamic("dist/components/navbar.component.js",["@angular/core"],!0,function(a,b,c){"use strict";var d=(this||self,this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g}),e=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)};const f=a("@angular/core");let g=class a{};return g=d([f.Component({selector:"navbar",templateUrl:"templates/navbar.html",styleUrls:["stylesheets/navbar.css"]}),e("design:paramtypes",[])],g),b.NavbarComponent=g,c.exports}),System.registerDynamic("dist/components/app.component.js",["@angular/core","../services/loader.service"],!0,function(a,b,c){"use strict";var d=(this||self,this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g}),e=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)};const f=a("@angular/core"),g=a("../services/loader.service");let h=class a{};return h=d([f.Component({selector:"app",templateUrl:"templates/app.html",providers:[g.LoaderService]}),e("design:paramtypes",[])],h),b.AppComponent=h,c.exports}),System.registerDynamic("dist/components/sidebar.component.js",["@angular/core","rxjs/Subject","../services/loader.service"],!0,function(a,b,c){"use strict";var d=(this||self,this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g}),e=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)};const f=a("@angular/core"),g=a("rxjs/Subject"),h=a("../services/loader.service");let i=class a{constructor(a,b){this.elementRef=a,this.renderer=b,this.fileUploadedSource=new g.Subject,this.fileUploaded$=this.fileUploadedSource.asObservable()}ngAfterViewInit(){const a=this.elementRef.nativeElement;a.addEventListener("change",a=>{const b=a.target.files[0];if(b){const a=new FileReader;a.onload=(a=>{this.fileUploadedSource.next(a.target.result)}),a.readAsText(b)}},!1)}};i=d([f.Directive({selector:"[uploader]"}),e("design:paramtypes",[f.ElementRef,f.Renderer])],i),b.SidebarUploaderDirective=i;let j=class a{constructor(a){this.loader=a,this.selectedModel=null,this.models=null,this.loading=!0}ngOnInit(){this.loader.getModelDescriptions().subscribe(a=>{this.models=a,this.loading=!1},a=>console.error(a))}ngAfterViewInit(){this.UploaderElement.fileUploaded$.subscribe(a=>{this.selectedModel=null,this.loader.loadModelFromBuffer(a)})}loadModel(a){this.loading=!0;const b=this.selectedModel;this.selectedModel=a,this.loader.loadModel(a).subscribe(()=>this.loading=!1,a=>{this.loading=!1,this.selectedModel=b,console.log(a),alert(a)})}};return d([f.ViewChild(i),e("design:type",i)],j.prototype,"UploaderElement",void 0),j=d([f.Component({selector:"sidebar",templateUrl:"templates/sidebar.html",styleUrls:["stylesheets/sidebar.css"]}),e("design:paramtypes",[h.LoaderService])],j),b.SidebarComponent=j,c.exports}),System.registerDynamic("dist/services/loader.service.js",["@angular/core","@angular/http","rxjs/Observable","rxjs/Subject","rxjs/add/operator/toPromise","rxjs/add/operator/map","rxjs/add/operator/catch","rxjs/add/observable/throw","../types/linalg.type"],!0,function(a,b,c){"use strict";var d=(this||self,this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g}),e=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)};const f=a("@angular/core"),g=a("@angular/http"),h=a("rxjs/Observable"),i=a("rxjs/Subject");a("rxjs/add/operator/toPromise"),a("rxjs/add/operator/map"),a("rxjs/add/operator/catch"),a("rxjs/add/observable/throw");const j=a("../types/linalg.type");let k=class a{constructor(a){this.http=a,this.ModelDescUrl="data/desc.json",this.modelLoadedSource=new i.Subject,this.modelLoaded$=this.modelLoadedSource.asObservable()}getModelDescriptions(){return this.http.get(this.ModelDescUrl).map(a=>a.json()).catch(this.handleError)}loadModel(a){return this.http.get(a.path).map(b=>{const c=this.processModel(a,b.text());return this.modelLoadedSource.next(c),c}).catch(this.handleError)}loadModelFromBuffer(a){const b={name:"User-Loaded Model",path:"Local",defaultCamera:{eye:[3,3,3],at:[0,0,0],up:[0,1,0]}},c=this.processModel(b,a);return this.modelLoadedSource.next(c),c}processModel(a,b){let c={vertices:[],faces:[],desc:a};for(let d of b.split(/[\r]{0,1}\n/))if(d.length){const a=d.split(/\s+/);if(!(a.length<4))switch(a[0]){case"v":c.vertices.push(new j.Vec4(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]),1));break;case"f":const b=parseInt(a[1])-1;for(let d=3;d<a.length;d++)c.faces.push({v1:b,v2:parseInt(a[d-1])-1,v3:parseInt(a[d])-1});break;default:console.log("unrecognized command "+a[0])}}return c}handleError(a){let b;return b=a instanceof g.Response?`${a.status} - ${a.statusText||""}`:a.message?a.message:a.toString(),h.Observable.throw(b)}};return k=d([f.Injectable(),e("design:paramtypes",[g.Http])],k),b.LoaderService=k,c.exports}),System.registerDynamic("dist/types/linalg.type.js",[],!0,function(a,b,c){"use strict";function d(a,b,c,d){const e=1/Math.tan(a/180*Math.PI*.5);return new h(e/b,0,0,0,0,e,0,0,0,0,(d+c)/(c-d),2*d*c/(c-d),0,0,-1,0)}function e(a,b,c){const d=b.sub(a).normalize(),e=d.cross(c.normalize()).normalize(),f=e.cross(d).normalize();return new h(e.d[0],e.d[1],e.d[2],-e.dot(a),f.d[0],f.d[1],f.d[2],-f.dot(a),-d.d[0],-d.d[1],-d.d[2],d.dot(a),0,0,0,1)}function f(a,b){return new h(.5*a,0,0,.5*a,0,.5*b,0,.5*b,0,0,1,0,0,0,0,1)}this||self;class g{constructor(a=0,b=0,c=0,d=0){this.d=[0,0,0,0],this.d[0]=a,this.d[1]=b,this.d[2]=c,this.d[3]=d}get x(){return this.d[0]}get y(){return this.d[1]}get z(){return this.d[2]}get w(){return this.d[3]}set x(a){this.d[0]=a}set y(a){this.d[1]=a}set z(a){this.d[2]=a}set w(a){this.d[3]=a}sub(a){return new g(this.d[0]-a.d[0],this.d[1]-a.d[1],this.d[2]-a.d[2],this.d[3]-a.d[3])}norm(){return Math.sqrt(this.d[0]*this.d[0]+this.d[1]*this.d[1]+this.d[2]*this.d[2]+this.d[3]*this.d[3])}normalize(){const a=this.norm();return new g(this.d[0]/a,this.d[1]/a,this.d[2]/a,this.d[3]/a)}dot(a){return this.d[0]*a.d[0]+this.d[1]*a.d[1]+this.d[2]*a.d[2]+this.d[3]*a.d[3]}cross(a){return new g(this.d[1]*a.d[2]-this.d[2]*a.d[1],this.d[2]*a.d[0]-this.d[0]*a.d[2],this.d[0]*a.d[1]-this.d[1]*a.d[0],0)}}b.Vec4=g;class h{constructor(a=0,b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0){this.d=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.d[0][0]=a,this.d[0][1]=b,this.d[0][2]=c,this.d[0][3]=d,this.d[1][0]=e,this.d[1][1]=f,this.d[1][2]=g,this.d[1][3]=h,this.d[2][0]=i,this.d[2][1]=j,this.d[2][2]=k,this.d[2][3]=l,this.d[3][0]=m,this.d[3][1]=n,this.d[3][2]=o,this.d[3][3]=p}apply(a){let b=new g;for(let c=0;c<4;c++)for(let d=0;d<4;d++)b.d[c]+=this.d[c][d]*a.d[d];return Math.abs(b.d[3])>1e-6&&(b.d[0]/=b.d[3],b.d[1]/=b.d[3],b.d[2]/=b.d[3],b.d[3]=1),b}mul(a){let b=new h;for(let c=0;c<4;c++)for(let d=0;d<4;d++)for(let e=0;e<4;e++)b.d[c][d]+=this.d[c][e]*a.d[e][d];return b}}return b.Mat4=h,b.buildProjectionMatrix=d,b.buildViewMatrix=e,b.buildViewportMatrix=f,c.exports}),System.registerDynamic("dist/components/view.component.js",["@angular/core","../services/loader.service","../types/linalg.type"],!0,function(a,b,c){"use strict";var d=(this||self,this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g}),e=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)};const f=a("@angular/core"),g=a("../services/loader.service"),h=a("../types/linalg.type");let i=class a{constructor(a,b){this.element=a,this.renderer=b,this.canvas=null,this.ctx=null,this.width=0,this.height=0,this.inputMesh=null,this.mesh=null,this.vpMatrix=null,this.camera={eye:new h.Vec4,at:new h.Vec4,up:new h.Vec4},this.zbuffer=null,this.canvas=a.nativeElement,this.ctx=this.canvas.getContext("2d"),this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.canvas.width=this.width,this.canvas.height=this.height,this.resetMatrices()}set model(a){this.inputMesh=a,this.onModelUpdated(a)}resetMatrices(){const a=70,b=.5,c=100,d=this.height?this.width/this.height:this.width;this.vpMatrix=h.buildViewportMatrix(this.width,this.height).mul(h.buildProjectionMatrix(a,d,b,c)),this.onModelUpdated(this.inputMesh)}setCameraFromNativeCamera(a){this.camera.eye=new h.Vec4(a.eye[0],a.eye[1],a.eye[2]),this.camera.at=new h.Vec4(a.at[0],a.at[1],a.at[2]),this.camera.up=new h.Vec4(a.up[0],a.up[1],a.up[2]),console.log(this.camera)}onModelUpdated(a){if(this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.width,this.height),null===a)return void(this.mesh=null);this.mesh={vertices:[],faces:a.faces,desc:a.desc},this.setCameraFromNativeCamera(this.mesh.desc.defaultCamera);const b=this.vpMatrix.mul(h.buildViewMatrix(this.camera.eye,this.camera.at,this.camera.up));for(let c of a.vertices)this.mesh.vertices.push(b.apply(c));this.calculateZbuffer(),this.drawZbuffer(),console.log("mesh updated")}getFaceBoundingRect(a){const b=this.mesh.vertices[a.v1],c=this.mesh.vertices[a.v2],d=this.mesh.vertices[a.v3];return{left:Math.max(0,Math.floor(Math.min(b.x,c.x,d.x))),right:Math.min(this.width-1,Math.ceil(Math.max(b.x,c.x,d.x))),top:Math.max(0,Math.floor(Math.min(b.y,c.y,d.y))),bottom:Math.min(this.height-1,Math.ceil(Math.max(b.y,c.y,d.y)))}}interpolateZ(a,b,c){const d=this.mesh.vertices[c.v1],e=this.mesh.vertices[c.v2],f=this.mesh.vertices[c.v3],g=.5*(-e.y*f.x+d.y*(-e.x+f.x)+d.x*(e.y-f.y)+e.x*f.y),h=1/(2*g)*(d.y*f.x-d.x*f.y+(f.y-d.y)*a+(d.x-f.x)*b),i=1/(2*g)*(d.x*e.y-d.y*e.x+(d.y-e.y)*a+(e.x-d.x)*b);return h>=0&&i>=0&&1-h-i>=0?(1-h-i)*d.z+h*e.z+i*f.z:NaN}calculateZbuffer(){this.zbuffer=[];for(let a=0;a<this.height;a++)this.zbuffer.push(new Float32Array(this.width).fill(1));for(let b of this.mesh.faces){const a=this.getFaceBoundingRect(b);for(let c=a.top;c<=a.bottom;c++)for(let d=a.left;d<=a.right;d++){const a=this.interpolateZ(d,c,b);a>=0&&a<this.zbuffer[c][d]&&(this.zbuffer[c][d]=a)}}}drawZbuffer(){const a=this.ctx.getImageData(0,0,this.width,this.height),b=a.data,c=4*this.width;for(let d=0;d<this.height;++d)for(let e=0;e<this.width;++e){const a=d*c+4*e,f=255*(1-this.zbuffer[d][e]);b[a]=f,b[a+1]=f,b[a+2]=f,b[a+3]=255}this.ctx.putImageData(a,0,0)}onResize(){clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.canvas.width=this.width,this.canvas.height=this.height,this.resetMatrices()},100)}};d([f.Input(),e("design:type",Object),e("design:paramtypes",[Object])],i.prototype,"model",null),d([f.HostListener("window:resize"),e("design:type",Function),e("design:paramtypes",[]),e("design:returntype",void 0)],i.prototype,"onResize",null),i=d([f.Directive({selector:"[view-canvas]"}),e("design:paramtypes",[f.ElementRef,f.Renderer])],i),b.ViewCanvasDirective=i;let j=class a{constructor(a){this.loader=a,this.m=null}ngOnInit(){this.loader.modelLoaded$.subscribe(a=>this.m=a)}ngAfterViewInit(){console.log("view init"),console.dir(this.canvas)}};return d([f.ViewChild(i),e("design:type",i)],j.prototype,"canvas",void 0),j=d([f.Component({selector:"view",template:'<canvas view-canvas [model]="m"></canvas>',styles:["canvas { width: 100%; height: 100%; }"]}),e("design:paramtypes",[g.LoaderService])],j),b.ViewComponent=j,c.exports}),System.registerDynamic("dist/modules/core.module.js",["@angular/core","@angular/platform-browser","@ng-bootstrap/ng-bootstrap","@angular/http","../components/navbar.component","../components/app.component","../components/sidebar.component","../components/view.component"],!0,function(a,b,c){"use strict";var d=(this||self,this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g}),e=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)};const f=a("@angular/core"),g=a("@angular/platform-browser"),h=a("@ng-bootstrap/ng-bootstrap"),i=a("@angular/http"),j=a("../components/navbar.component"),k=a("../components/app.component"),l=a("../components/sidebar.component"),m=a("../components/view.component");let n=class a{};return n=d([f.NgModule({imports:[g.BrowserModule,i.HttpModule,i.JsonpModule,h.NgbModule.forRoot()],declarations:[k.AppComponent,j.NavbarComponent,l.SidebarComponent,l.SidebarUploaderDirective,m.ViewComponent,m.ViewCanvasDirective],bootstrap:[k.AppComponent]}),e("design:paramtypes",[])],n),b.CoreModule=n,c.exports}),System.registerDynamic("dist/index.js",["@angular/platform-browser-dynamic","./modules/core.module"],!0,function(a,b,c){"use strict";this||self;const d=a("@angular/platform-browser-dynamic"),e=a("./modules/core.module");return d.platformBrowserDynamic().bootstrapModule(e.CoreModule),c.exports}),System.registerDynamic("dist/modules/core.js",["@angular/core","@angular/platform-browser"],!0,function(a,b,c){"use strict";var d=(this||self,this&&this.__decorate||function(a,b,c,d){var e,f=arguments.length,g=f<3?b:null===d?d=Object.getOwnPropertyDescriptor(b,c):d;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)g=Reflect.decorate(a,b,c,d);else for(var h=a.length-1;h>=0;h--)(e=a[h])&&(g=(f<3?e(g):f>3?e(b,c,g):e(b,c))||g);return f>3&&g&&Object.defineProperty(b,c,g),g}),e=a("@angular/core"),f=a("@angular/platform-browser"),g=function(){function a(){}return a=d([e.NgModule({imports:[f.BrowserModule],declarations:[],bootstrap:[]})],a)}();return b.CoreModule=g,c.exports}),System.registerDynamic("dist/types/event.type.js",[],!1,function(a,b,c){var d=System.get("@@global-helpers").prepareGlobal(c.id,null,null);return function(a){}(this),d()}),System.registerDynamic("dist/types/math.type.js",[],!1,function(a,b,c){var d=System.get("@@global-helpers").prepareGlobal(c.id,null,null);return function(a){}(this),d()}),System.registerDynamic("dist/types/model.js",[],!1,function(a,b,c){var d=System.get("@@global-helpers").prepareGlobal(c.id,null,null);return function(a){}(this),d()}),System.registerDynamic("dist/types/model.type.js",[],!1,function(a,b,c){var d=System.get("@@global-helpers").prepareGlobal(c.id,null,null);return function(a){}(this),d()}),System.registerDynamic("dist/types/view.type.js",[],!1,function(a,b,c){var d=System.get("@@global-helpers").prepareGlobal(c.id,null,null);return function(a){}(this),d()});
//# sourceMappingURL=zbuffer.js.map